name: Deploy to Aliyun Server

on:
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
  
  # å½“æ¨é€åˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨è§¦å‘
  push:
    branches: [ main ]
  
  # å½“ PR åˆå¹¶åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  pull_request:
    branches: [ main ]
    types: [ closed ]

jobs:
  deploy:
    name: éƒ¨ç½²åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨
    runs-on: ubuntu-latest
    
    # åªåœ¨ PR åˆå¹¶æ—¶æˆ–æ‰‹åŠ¨è§¦å‘æ—¶æ‰§è¡Œ
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: æ„å»ºé¡¹ç›®
      run: npm run build
      
    - name: åˆ›å»ºéƒ¨ç½²åŒ…
      run: |
        mkdir -p deploy
        cp -r .next deploy/
        cp -r public deploy/
        cp package.json deploy/
        cp package-lock.json deploy/
        cp next.config.ts deploy/
        tar -czf deploy.tar.gz -C deploy .
        
    - name: éƒ¨ç½²åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.ALIYUN_HOST }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        key: ${{ secrets.ALIYUN_SSH_KEY }}
        port: ${{ secrets.ALIYUN_PORT || 22 }}
        script: |
          # è®¾ç½®éƒ¨ç½²ç›®å½•
          DEPLOY_DIR="/var/www/space-s"
          BACKUP_DIR="/var/www/backups/space-s-$(date +%Y%m%d_%H%M%S)"
          
          # åˆ›å»ºå¤‡ä»½
          if [ -d "$DEPLOY_DIR" ]; then
            echo "åˆ›å»ºå¤‡ä»½åˆ° $BACKUP_DIR"
            sudo mkdir -p $(dirname $BACKUP_DIR)
            sudo cp -r $DEPLOY_DIR $BACKUP_DIR
          fi
          
          # åˆ›å»ºéƒ¨ç½²ç›®å½•
          sudo mkdir -p $DEPLOY_DIR
          cd $DEPLOY_DIR
          
          # åœæ­¢ç°æœ‰æœåŠ¡ (å¦‚æœä½¿ç”¨ PM2)
          sudo pm2 stop space-s || true
          
          # æ¸…ç†æ—§æ–‡ä»¶
          sudo rm -rf .next public package.json package-lock.json next.config.ts node_modules
          
    - name: ä¸Šä¼ éƒ¨ç½²åŒ…
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.ALIYUN_HOST }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        key: ${{ secrets.ALIYUN_SSH_KEY }}
        port: ${{ secrets.ALIYUN_PORT || 22 }}
        source: "deploy.tar.gz"
        target: "/tmp/"
        
    - name: è§£å‹å¹¶å¯åŠ¨æœåŠ¡
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.ALIYUN_HOST }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        key: ${{ secrets.ALIYUN_SSH_KEY }}
        port: ${{ secrets.ALIYUN_PORT || 22 }}
        script: |
          DEPLOY_DIR="/var/www/space-s"
          
          # è§£å‹éƒ¨ç½²åŒ…
          cd $DEPLOY_DIR
          sudo tar -xzf /tmp/deploy.tar.gz
          sudo chown -R $(whoami):$(whoami) .
          
          # å®‰è£…ç”Ÿäº§ä¾èµ–
          npm ci --only=production
          
          # å¯åŠ¨æœåŠ¡ (ä½¿ç”¨ PM2)
          pm2 start npm --name "space-s" -- start || pm2 restart space-s
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f /tmp/deploy.tar.gz
          
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          echo "ğŸš€ åº”ç”¨å·²å¯åŠ¨åœ¨ç«¯å£ 3000"
          
    - name: éƒ¨ç½²çŠ¶æ€é€šçŸ¥
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
        fi 